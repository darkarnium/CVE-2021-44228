#!/bin/bash

set -uo pipefail

# Ensure Docker.
if [ "x$(which docker)" == "x" ]; then
    echo "ERROR: Unable to find docker, exiting. Please install 'docker' to continue."
    exit 1
fi

# Ensure python.
PYTHON="$(which python3)"

if [ -z "${PYTHON}" ]; then
    PYTHON="$(which python)"

    if [ -z "${PYTHON}" ]; then
        echo "ERROR: Unable to find python, exiting. Please install 'python' to continue."
        exit 1
    fi
fi

# Run it.
docker run \
    --rm \
    --mount "type=bind,source=$(pwd)/artifacts,target=/mnt/stacs/input" \
    --mount "type=bind,source=$(pwd)/rules,target=/mnt/stacs/rules" \
    stacscan/stacs:latest \
      --rule-pack "/mnt/stacs/rules/vulnerability.json" \
      "/mnt/stacs/input" | python3 present.py
